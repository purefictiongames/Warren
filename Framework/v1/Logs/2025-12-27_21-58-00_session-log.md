# Session Log: 2025-12-27 (Session 10)

## Overview

This session implemented the complete RoastingStick workflow: auto-equip on spawn, marshmallow mounting/unmounting, one-at-a-time rule with force drop, and visual cooking feedback. Also created the Backpack subsystem for centralized backpack event handling.

---

## 1. RoastingStick Handle

### Created Handle.rbxm

User created a cylinder Part in Studio and exported it:
- Location: `src/Templates/RoastingStick/Handle.rbxm`
- Initially exported to wrong location (Assets), moved to Templates

### Grip Properties

Set grip so stick points forward instead of sideways:
```lua
stick.GripForward = Vector3.new(1, 0, 0)
stick.GripUp = Vector3.new(0, 1, 0)
```

Note: Attempted to add GripPos for 1/4 grip offset but it broke mounting - reverted.

---

## 2. Backpack Subsystem

### Architecture

Created new System module parallel to Player:
```
System/
├── Player/
└── Backpack/
    ├── init.meta.json
    ├── ServerScriptService/
    │   └── Script.server.lua
    └── ReplicatedStorage/
        ├── ItemAdded/        # Fires when item added to backpack
        ├── ForceItemDrop/    # Drops item on ground
        └── ForceItemPickup/  # Adds item to backpack
```

### Events

| Event | Fired By | Handled By |
|-------|----------|------------|
| `Backpack.ItemAdded` | Backpack system | RoastingStick (mount marshmallow) |
| `Backpack.ForceItemDrop` | RoastingStick (mount fail) | Backpack (drop on ground) |
| `Backpack.ForceItemPickup` | TimedEvaluator (unmount) | Backpack (add to inventory) |

### System Bootstrap Fix

Fixed child module SSS deployment - was incorrectly skipping:
```lua
-- Before: bootstrapModule(child, child.Name, isInServerScriptService)
-- After:
bootstrapModule(child, child.Name, false)  -- Always deploy child SSS folders
```

---

## 3. Marshmallow Mounting

### Flow: Dispenser → Mount
```
Dispenser gives marshmallow → Backpack
        ↓
Backpack.ItemAdded fires
        ↓
RoastingStick receives, filters for "Marshmallow"
        ↓
mountMarshmallow() - positions at stick tip, welds
        ↓
Success: marshmallow parented to stick
Fail: Backpack.ForceItemDrop → dropped on ground
```

### Positioning Code
```lua
-- Cylinder length is along X axis
local tipOffset = stickHandle.Size.X / 2 + marshmallowHandle.Size.Y / 2
marshmallowHandle.CFrame = stickHandle.CFrame * CFrame.new(tipOffset, 0, 0)

-- Weld to stick
local weld = Instance.new("WeldConstraint")
weld.Part0 = stickHandle
weld.Part1 = marshmallowHandle
weld.Parent = marshmallowHandle
```

### One Marshmallow Rule

If stick already has a marshmallow mounted, mount fails with `"already_mounted"` and the extra marshmallow is dropped on the ground. This creates a natural penalty for spamming the Dispenser.

---

## 4. Marshmallow Unmounting

### Flow: Interact with TimedEvaluator
```
Player triggers TimedEvaluator prompt
        ↓
findMountedItem() - looks in Character.RoastingStick
        ↓
unmountToBackpack() - removes weld, fires ForceItemPickup
        ↓
Backpack receives, adds to player's Backpack
        ↓
findAcceptedItem() - finds in Backpack
        ↓
evaluate() and destroy
```

### Unmount Code
```lua
local function unmountToBackpack(player, item)
    local handle = item:FindFirstChild("Handle")
    if handle then
        local weld = handle:FindFirstChild("WeldConstraint")
        if weld then
            weld:Destroy()
        end
    end
    forceItemPickup:Fire({ player = player, item = item })
end
```

---

## 5. ZoneController Deep Search Fix

### Problem
ZoneController couldn't find marshmallows mounted on RoastingStick because:
1. Search only happened on zone entry (cached), not per-tick
2. `Player.Character` is not a child of `Player` - it's in Workspace

### Solution
1. Re-search on every tick instead of caching on entry
2. For players, explicitly search Character and Backpack:
```lua
if isPlayer then
    local character = root.Character
    if character then search(character) end
    local backpack = root:FindFirstChild("Backpack")
    if backpack then search(backpack) end
else
    search(root)
end
```

---

## 6. Marshmallow Color Change

### Toast Level Brackets (25% each)

| ToastLevel | Color | RGB |
|------------|-------|-----|
| 0-25 | Raw → Golden | (255,250,240) → (210,160,60) |
| 25-50 | Golden → Burnt | (210,160,60) → (60,30,10) |
| 50-75 | Burnt → Blackened | (60,30,10) → (15,10,5) |
| 75-100 | Fully Blackened | (15,10,5) |

### Implementation
```lua
local function getToastColor(level)
    if level <= 25 then
        return TOAST_COLORS.raw:Lerp(TOAST_COLORS.golden, level / 25)
    elseif level <= 50 then
        return TOAST_COLORS.golden:Lerp(TOAST_COLORS.burnt, (level - 25) / 25)
    elseif level <= 75 then
        return TOAST_COLORS.burnt:Lerp(TOAST_COLORS.blackened, (level - 50) / 25)
    else
        return TOAST_COLORS.blackened
    end
end
```

Max ToastLevel changed from 150 to 100.

---

## 7. Files Changed

### New Files
```
src/System/Backpack/
├── init.meta.json
├── ServerScriptService/Script.server.lua
└── ReplicatedStorage/
    ├── ItemAdded/init.meta.json
    ├── ForceItemDrop/init.meta.json
    └── ForceItemPickup/init.meta.json

src/Templates/RoastingStick/Handle.rbxm
```

### Modified Files
- `src/System/Script.server.lua` - Fixed child module SSS deployment
- `src/System/Player/ServerScriptService/Script.server.lua` - Cleaned up (backpack logic moved)
- `src/Assets/RoastingStick/ServerScriptService/Script.server.lua` - Mount/unmount, grip, events
- `src/Assets/ZoneController/ServerScriptService/Script.server.lua` - Per-tick search, player-aware
- `src/Assets/TimedEvaluator/ServerScriptService/Script.server.lua` - Unmount before evaluate
- `src/Templates/Marshmallow/Script.server.lua` - Color change, max 100

---

## 8. Event Flow Summary

```
SPAWN:
RoastingStick → gives stick → auto-equips

DISPENSE:
Dispenser → Backpack.ItemAdded → RoastingStick mounts (or drops)

COOK:
ZoneController tick → deep search → Marshmallow.cook() → color updates

SUBMIT:
TimedEvaluator prompt → unmount → ForceItemPickup → Backpack
                      → findAcceptedItem → evaluate → destroy

SPAM PENALTY:
Second marshmallow → mount fails → ForceItemDrop → on ground
```

---

## 9. Emergent Mechanics

### Dispenser Spam Penalty
Players who spam the Dispenser waste marshmallows - they get dropped on the ground because only one can be mounted at a time. Natural consequence without explicit "limit" code.

### Blackened Marshmallows
Added 4th color stage (75-100) for properly blackened marshmallows per user preference.

---

## 10. Known Issues / Future Work

1. **GripPos breaks mounting** - Attempted to offset grip to 1/4 from bottom, but it broke mounting. May need different approach (set on template in Studio).
2. **Grip position** - Currently holding stick in middle, would prefer 1/4 from bottom.
