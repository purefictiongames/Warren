# Session Log: 2025-12-28 (Session 11)

## Overview

This session fixed a critical bug where scripts nested inside the System folder were auto-running in addition to their deployed copies, causing duplicate event handling. Also fixed Backpack.ChildAdded not firing in published games by re-watching on character respawn.

---

## 1. Duplicate Script Bug

### Problem

Scripts in `ServerScriptService/System/Backpack/_ServerScriptService/Script` were auto-running because they were descendants of the actual ServerScriptService, even though they were inside folders.

This caused:
- Two copies of Backpack.Script running
- ChildAdded events firing twice
- RoastingStick receiving ItemAdded events x2

### Root Cause

Rojo syncs `src/System` to `ServerScriptService.System`. Any `.server.lua` file inside this hierarchy becomes a Script that auto-runs because it's a descendant of ServerScriptService - regardless of folder nesting.

```
ServerScriptService/
└── System/
    ├── Script                    ← Runs (intended - bootstrap)
    └── Backpack/
        └── ServerScriptService/  ← Just a Folder, not special
            └── Script            ← ALSO RUNS (unintended!)
```

### Solution

Renamed all `ServerScriptService` folders to `_ServerScriptService` (underscore prefix). This prevents scripts from auto-running while maintaining the folder structure for deployment.

```bash
# Renamed folders
src/System/Backpack/ServerScriptService → _ServerScriptService
src/System/Player/ServerScriptService → _ServerScriptService
src/Assets/*/ServerScriptService → _ServerScriptService
```

Updated `System.Script` to look for `_ServerScriptService`:

```lua
local SERVICE_FOLDERS = {
    ReplicatedStorage = ReplicatedStorage,
    _ServerScriptService = ServerScriptService,  -- Underscore prefix
    StarterPlayerScripts = StarterPlayer.StarterPlayerScripts,
    StarterGui = StarterGui,
}

local SERVICE_ORDER = {
    "ReplicatedStorage",
    "StarterGui",
    "StarterPlayerScripts",
    "_ServerScriptService",  -- Scripts last
}
```

---

## 2. ChildAdded Not Firing in Published Games

### Problem

Backpack.ChildAdded wasn't firing when the Dispenser added items in published games, even though both were using the same backpack path.

### Root Cause

The Backpack instance reference becomes stale after character respawn. The connection was made to the original Backpack, but after respawn, a new Backpack instance is created.

### Solution

Re-watch the backpack on every CharacterAdded:

```lua
local function watchBackpack(player)
    -- Watch current backpack
    local backpack = player:FindFirstChild("Backpack") or player:WaitForChild("Backpack", 10)
    if backpack then
        connectBackpackEvents(player, backpack)
    end

    -- Re-watch when character spawns (Backpack gets recreated)
    player.CharacterAdded:Connect(function()
        task.wait(0.1) -- Let Backpack initialize
        local newBackpack = player:FindFirstChild("Backpack")
        if newBackpack then
            connectBackpackEvents(player, newBackpack)
        end
    end)
end
```

---

## 3. Files Changed

### Renamed Folders
```
src/System/Backpack/ServerScriptService → _ServerScriptService
src/System/Player/ServerScriptService → _ServerScriptService
src/Assets/Dispenser/ServerScriptService → _ServerScriptService
src/Assets/GlobalTimer/ServerScriptService → _ServerScriptService
src/Assets/LeaderBoard/ServerScriptService → _ServerScriptService
src/Assets/Orchestrator/ServerScriptService → _ServerScriptService
src/Assets/RoastingStick/ServerScriptService → _ServerScriptService
src/Assets/Scoreboard/ServerScriptService → _ServerScriptService
src/Assets/TimedEvaluator/ServerScriptService → _ServerScriptService
src/Assets/ZoneController/ServerScriptService → _ServerScriptService
```

### Modified Files
- `src/System/Script.server.lua` - Updated SERVICE_FOLDERS and SERVICE_ORDER to use `_ServerScriptService`
- `src/System/Backpack/_ServerScriptService/Script.server.lua` - Added CharacterAdded re-watch, cleaned up debug logging

---

## 4. Key Learnings

### Roblox Script Auto-Run Behavior

Scripts auto-run when they are descendants of:
- ServerScriptService (the actual service)
- Workspace
- Other runnable containers

A folder *named* "ServerScriptService" inside ServerScriptService is just a regular Folder - it has no special meaning. But scripts inside it ARE descendants of the actual ServerScriptService, so they run.

### Solution Pattern

When storing scripts that should only run after deployment:
1. Use underscore prefix (`_ServerScriptService`) to prevent auto-run
2. Or store in ReplicatedStorage (scripts don't auto-run there)
3. Deploy/clone to actual service when ready

---

## 5. Architecture Notes

The System bootstrap pattern is now:

1. `System.Script` runs (the only auto-running script)
2. It deploys modules from `_ServerScriptService` folders to actual ServerScriptService
3. Scripts start running only after being deployed with proper naming

This ensures deterministic deployment order (events before scripts) and prevents duplicate execution.
