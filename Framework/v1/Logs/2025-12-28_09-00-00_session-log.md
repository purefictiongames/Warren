# Session Log: 2025-12-28 (Session 12)

## Overview

This session added the MessageTicker notification system for player-facing messages, fixed duplicate script execution in test environments, and identified the need for a System-level runlevel/boot system to properly sequence asset deployment and event initialization.

---

## 1. MessageTicker Asset (Player Notifications)

### Concept

MessageTicker is a server-to-client notification system that displays contextual messages to players with fade-out animation. Examples:
- "Roast your marshmallow over the campfire!" (on dispense)
- "You dropped a marshmallow! (You can only carry one at a time)" (spam prevention)
- "The bag is empty!" (dispenser depleted)

### Design Decisions

**Code-Based GUI Creation**
- ScreenGui created via LocalScript, not .rbxm export
- Faster iteration, avoids Rojo sync issues with UI elements
- Follows pattern established with Dispenser BillboardGui

**Lazy Event Loading**
- RemoteEvent loaded via `task.spawn` to avoid blocking script setup
- Prevents race conditions where event isn't deployed yet
- Graceful fallback if event not found (message just doesn't show)

### Filesystem Structure

```
src/Assets/MessageTicker/
├── init.meta.json                          # className: "Model"
├── ReplicatedStorage/
│   └── MessageTicker/
│       └── init.meta.json                  # className: "RemoteEvent"
└── StarterGui/
    └── LocalScript.client.lua              # Creates GUI, handles fade
```

### Styling Specs

| Property | Value |
|----------|-------|
| Font | Bangers |
| Size | 36pt |
| Color | RGB(255, 170, 0) - Orange/Gold |
| Background | Transparent |
| Height | 50px |
| Width | Full screen |
| Position | Bottom center, 120px above toolbar |
| Fade Delay | 3 seconds |
| Fade Duration | 1 second |

### Server Usage

```lua
-- Load lazily to avoid blocking
local messageTicker = nil
task.spawn(function()
    messageTicker = ReplicatedStorage:WaitForChild("MessageTicker.MessageTicker", 10)
end)

-- Send message (with nil check)
if messageTicker then
    messageTicker:FireClient(player, "Your message here!")
end
```

### Integrated Into

- **Dispenser** - "Roast your marshmallow..." on dispense, "The bag is empty!" when depleted
- **RoastingStick** - "You dropped a marshmallow!..." when mount fails due to already_mounted

---

## 2. Duplicate Script Execution Fix

### Problem

Scripts in `System/Backpack/_ServerScriptService/` and `System/Player/_ServerScriptService/` were running twice:
1. Once as the deployed version (e.g., `Backpack.Script`)
2. Once as the original (e.g., `Script`)

This caused `Backpack.ChildAdded` to fire twice, resulting in:
- Double ItemAdded events
- "already_mounted" errors on first marshmallow dispense
- Race conditions in mounting logic

### Root Cause

Session 11's fix (renaming folders to `_ServerScriptService`) was based on incorrect assumption. The folder NAME doesn't affect script execution - what matters is whether the script is a **descendant of ServerScriptService** (the actual service).

Since Rojo syncs `src/System` to `ServerScriptService.System`, ALL scripts inside are descendants of ServerScriptService and auto-run, regardless of folder naming.

```
ServerScriptService/           ← The actual service
└── System/                    ← Rojo syncs here
    └── Backpack/
        └── _ServerScriptService/   ← Just a folder name, no special meaning
            └── Script.server.lua   ← RUNS because it's under ServerScriptService
```

### Solution

Added script name guards at the top of affected scripts:

```lua
-- Guard: Only run if this is the deployed version (name starts with "Backpack.")
-- The original in _ServerScriptService will have name "Script" and should not run
if not script.Name:match("^Backpack%.") then
    return
end
```

When System deploys scripts, it prefixes them with their module name:
- Original: `Script` (in _ServerScriptService folder) → exits early
- Deployed: `Backpack.Script` (in ServerScriptService root) → runs

### Files Modified

- `src/System/Backpack/_ServerScriptService/Script.server.lua` - Added guard
- `src/System/Player/_ServerScriptService/Script.server.lua` - Added guard

---

## 3. Marshmallow Mounting Fixes

### Issue 1: Collision on Dispense

**Symptom:** Player getting "welded" to dispenser bag in test environment.

**Cause:** Marshmallow Handle had physics enabled when parented to Backpack.

**Fix:** Disable `CanCollide` on Handle before parenting:

```lua
-- In Dispenser.Script, before item.Parent = backpack
local handle = item:FindFirstChild("Handle")
if handle then
    handle.CanCollide = false
end
```

### Issue 2: Destroyed Item Error

**Symptom:** Error when submitting marshmallow to TimedEvaluator:
```
The Parent property of Marshmallow is locked, current parent: NULL
```

**Cause:**
1. TimedEvaluator unmounts marshmallow → moves to Backpack
2. ItemAdded fires → RoastingStick tries to mount
3. TimedEvaluator destroys the item
4. RoastingStick tries to drop destroyed item

**Fix:** Check if item still exists before mounting:

```lua
-- After task.wait(0.1)
if not item:IsDescendantOf(game) then
    print("RoastingStick: Item no longer exists, skipping mount")
    return
end
```

---

## 4. Architecture Discussion: Asset Types

### Current Pattern Limitation

All assets use the Model pattern with service folder extraction. But MessageTicker is a pure service (RemoteEvent + ScreenGui) with no physical component.

### Future Reorganization (Not Implemented)

```
src/
├── Assets/          # Physical Models (Dispenser, ZoneController, etc.)
├── Services/        # Pure services (MessageTicker, future: Analytics, etc.)
├── Templates/       # Cloneable items (Marshmallow, RoastingStick)
└── System/          # Core bootstrap + subsystems
```

Flagged for later refactor when more non-physical services emerge.

---

## 5. Future: Runlevel Boot System

### Problem Identified

Current bootstrap has race conditions:
- Scripts wait on events that may not be deployed yet
- Each asset needs boilerplate lazy loading
- No guaranteed deployment order
- Event bindings scattered, hard to debug

### Proposed Solution: Linux-Style Runlevels

```
Level 0: SYNC       - Assets cloned to RuntimeAssets, service folders extracted
Level 1: EVENTS     - All RemoteEvents/BindableEvents created and registered
Level 2: MODULES    - ModuleScripts deployed and requireable
Level 3: SCRIPTS    - Server scripts deployed and running
Level 4: READY      - Boot complete, players can interact
```

### Key Insight

Scripts auto-run when parented to ServerScriptService. We can't prevent that. So deployment must be phased:

**Phase 1:** Deploy ReplicatedStorage, StarterGui, StarterPlayerScripts
- Events exist
- Modules exist
- UI elements exist

**Phase 2:** Deploy _ServerScriptService
- Scripts start running
- All dependencies guaranteed to exist

### Implementation Approach (For Next Session)

1. Refactor `System.Script` deployment order
2. First pass: Deploy all non-script service folders
3. Second pass: Deploy _ServerScriptService folders
4. Optional: Add event registry module for cleaner access

---

## 6. Emergent Mechanics Discovered

### Stickless Roasting

Player can unequip RoastingStick and hold marshmallow directly. Still cooks, still submittable.

**Future Enhancement:** Taking damage (burns) when roasting without stick.

### Stick Durability (Planned)

RoastingSticks will degrade with use and need replacement. Creates resource management.

### Dropped Marshmallow Theft (Planned)

Animals will steal dropped marshmallows. Adds consequence to spam/accidents.

---

## 7. Files Changed

### New Files

```
src/Assets/MessageTicker/
├── init.meta.json
├── ReplicatedStorage/MessageTicker/init.meta.json
└── StarterGui/LocalScript.client.lua
```

### Modified Files

| File | Changes |
|------|---------|
| `Dispenser/_ServerScriptService/Script.server.lua` | MessageTicker integration, CanCollide fix |
| `RoastingStick/_ServerScriptService/Script.server.lua` | MessageTicker integration, destroyed item check, debug logging |
| `System/Backpack/_ServerScriptService/Script.server.lua` | Script name guard |
| `System/Player/_ServerScriptService/Script.server.lua` | Script name guard |

### Deleted Files

```
src/Assets/ClientMessage/  (replaced by MessageTicker)
```

---

## 8. Current Asset Summary

| Asset | Type | Purpose |
|-------|------|---------|
| Dispenser | Physical | Gives marshmallows, BillboardGui count |
| ZoneController | Physical | Cooks via BindableFunction callbacks |
| TimedEvaluator | Physical | Timed scoring with satisfaction HUD |
| Scoreboard | Service | Score calculation + ScreenGui |
| GlobalTimer | Service | Round countdown + ScreenGui |
| Orchestrator | Service | Event coordinator |
| LeaderBoard | Physical | Persistent top 10 (SurfaceGui) |
| RoastingStick | Service | Auto-equip tool, mounts marshmallows |
| MessageTicker | Service | Player notification system |

---

## 9. Test Results

### Test Environment (Studio)

- ✅ No duplicate script execution
- ✅ Marshmallow mounts on first dispense
- ✅ "Already mounted" correctly detected on second dispense
- ✅ Marshmallow cooks in zone
- ✅ Submission to TimedEvaluator works
- ✅ No errors on submission (destroyed item handled)
- ✅ MessageTicker displays notifications

### Published Environment

- ✅ All above tests pass

---

## 10. Next Steps

1. **Implement Runlevel System** - Major refactor of System.Script for phased deployment
2. **Event Registry** - Optional centralized event access module
3. **Asset Type Reorganization** - Separate physical assets from services
4. **Stick Durability** - RoastingStick degradation system
5. **Damage System** - Player damage for stickless roasting
6. **Animal AI** - Creatures that steal dropped marshmallows
