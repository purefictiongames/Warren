# Session Log: 2025-12-25 (Session 2)

## Overview

This session focused on simplifying the deployment architecture - moving away from Roblox Packages and Toolbox distribution toward a Rojo-first workflow where the filesystem is the single source of truth.

---

## 1. Initial Context

- Read previous session log to restore context
- Previous session established self-bootstrapping System with service folder extraction
- User wanted to discuss Roblox Package distribution for System

---

## 2. Architecture Discussion: Packages vs Rojo

### Original Plan
- System (including Player) → Roblox Package (linked into new projects)
- Assets/Tools → Exported RBXL files, imported via Toolbox
- Workflow: New project → Link Package → Drop assets from Toolbox → Configure → Play

### Problem Identified
Assets dropped from Toolbox need folders (`ReplicatedStorage/Assets`, etc.) to exist at edit time, but a Package in `ServerScriptService` can't create folders in `ReplicatedStorage` just by being linked.

### Solutions Considered
1. Project template (pre-configured folders)
2. Companion plugin (creates folders on click)
3. Manual folder creation
4. Package includes ReplicatedStorage structure

### Plugin Built (Later Removed)
Created `Plugin/SystemSetup.lua` - a Studio plugin to create required folders. Featured:
- Toolbar button "Setup" under "System"
- Creates Assets, Tools, Templates folders in ReplicatedStorage
- Visual feedback (button state) when folders exist

---

## 3. The Pivot: Rojo-First Workflow

### User Insight
> "Why am I worrying about packages and dropping things from toolbox? If we do it this way as a pattern/workflow, anytime we open a new project and connect to rojo, it does all of this for us anyway."

### New Architecture
Rojo syncs everything from filesystem - no Packages, no Toolbox needed.

**Workflow:**
1. New Roblox project
2. Connect Rojo to `Framework/v1`
3. Everything syncs - System, Assets, folder structure
4. Build your game

**For future versions:**
- Point Rojo at `Framework/v2`
- Done

### What This Eliminated
- Roblox Packages (not needed)
- Toolbox distribution (not needed)
- The plugin we built (Rojo syncs folders)
- Runtime edit-time folder creation

### What Remained
- `Workspace/RuntimeAssets` creation at runtime (legitimate runtime folder for deployed clones)

---

## 4. Cleanup: System Script

Removed `ensureRequiredFolders()` and related code since Rojo handles edit-time folder structure.

### Final System Script Responsibilities
1. Detect if running as Package (already in ServerScriptService)
2. Bootstrap System and child modules (Player, etc.)
   - Skip ServerScriptService extraction if already in SSS
3. Create `Workspace/RuntimeAssets` at runtime
4. Deploy assets from `ReplicatedStorage/Assets` to RuntimeAssets

---

## 5. Rojo + Physical Components (.rbxm)

### Problem
Rojo nukes non-script content (Anchor Part, ProximityPrompt) on every sync because they weren't in the filesystem.

### Solution
Export physical components as `.rbxm` files:

1. In Studio: Select Anchor (with ProximityPrompt child)
2. Right-click → Save to File → `Anchor.rbxm`
3. Place in `src/Assets/Dispenser/Anchor.rbxm`

Rojo now syncs the physical component as part of the model.

### Git Tracking
`.rbxm` files are fine to commit:
- Small files (Part + ProximityPrompt is tiny)
- Integral to asset functionality
- Version controls physical structure

Would use Git LFS for: huge meshes, textures, binary churn

---

## 6. Design Rules Updated

### Rule: Rojo is Source of Truth
The filesystem defines everything. Rojo syncs it to Studio. No manual component creation except for testing/prototyping (then export to `.rbxm`).

### Rule: Runtime vs Edit-Time Folders
- **Edit-time folders** (Assets, Tools, Templates): Defined in filesystem, synced by Rojo
- **Runtime folders** (RuntimeAssets): Created by System script when game runs

---

## 7. Current File Structure

```
Framework/v1/
├── default.project.json
├── wally.toml
├── .gitignore
├── Logs/
│   ├── 2025-12-25_19-08-36_session-log.md
│   └── 2025-12-25_20-08-18_session-log.md
└── src/
    ├── Assets/
    │   └── Dispenser/
    │       ├── init.meta.json
    │       ├── Anchor.rbxm              # NEW: Physical component
    │       ├── ReplicatedStorage/
    │       │   └── ModuleScript.lua
    │       └── ServerScriptService/
    │           └── Script.server.lua
    ├── Authentication/
    │   ├── Client/
    │   ├── Server/
    │   └── Shared/
    │       ├── Authentication.shared.lua
    │       └── Permissions.shared.lua
    └── System/
        ├── init.meta.json
        ├── Script.server.lua            # Updated: Package detection
        └── Player/
            └── init.meta.json
```

---

## 8. Git Commits This Session

```
88f47b3 Add Rojo-managed Anchor.rbxm and improve System bootstrap
```

Changes:
- Added `Anchor.rbxm` for Rojo-managed physical components
- Updated System script with `skipServerScripts` parameter
- Removed `ensureRequiredFolders()` (Rojo handles this)
- Added asset count to bootstrap output

---

## 9. Key Concepts Reference

### .rbxm Files
Binary Roblox model files. Used to version control physical components (Parts, MeshParts, UI elements) that Rojo can't represent as scripts/JSON.

**Workflow:**
1. Build component in Studio
2. Export as `.rbxm`
3. Place in appropriate filesystem location
4. Rojo syncs it back

### skipServerScripts Pattern
When System runs as a Roblox Package (already in ServerScriptService), it skips extracting its own `ServerScriptService/` folder to avoid duplication:

```lua
local isInServerScriptService = System:IsDescendantOf(ServerScriptService)
bootstrapModule(System, "System", isInServerScriptService)
```

---

## 10. Dispenser Asset Module (Detailed Reference)

### Overview

Dispenser is a generic, configurable asset that dispenses items from the Templates folder. It demonstrates the full asset module pattern: filesystem structure, service folder extraction, physical components via `.rbxm`, and attribute-based configuration.

### Filesystem Structure

```
src/Assets/Dispenser/
├── init.meta.json              # Tells Rojo this is a Model, not Folder
├── Anchor.rbxm                 # Physical component (Part + ProximityPrompt)
├── ReplicatedStorage/
│   └── ModuleScript.lua        # Dispenser class (shared)
└── ServerScriptService/
    └── Script.server.lua       # ProximityPrompt handler (server)
```

### init.meta.json

```json
{
  "className": "Model"
}
```

Tells Rojo to create a Model instance instead of a Folder. Required for assets that need to be physical objects in the world.

### Anchor.rbxm Contents

Exported from Studio. Contains:
- **Anchor** (Part) - The physical hitbox/interaction point
  - **ProximityPrompt** (child) - Triggers the dispense action

The Anchor is typically made transparent at runtime if a mesh is used for visuals.

### Dispenser Class (ReplicatedStorage/ModuleScript.lua)

```lua
-- Dispenser.ModuleScript (Shared)
-- Generic dispenser class - clones items from Templates folder

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Dispenser = {}
Dispenser.__index = Dispenser

function Dispenser.new(itemType, capacity)
    local self = setmetatable({}, Dispenser)
    self.itemType = itemType
    self.capacity = capacity
    self.remaining = capacity
    return self
end

function Dispenser:dispense()
    if self.remaining <= 0 then
        return nil
    end

    local templates = ReplicatedStorage:FindFirstChild("Templates")
    if not templates then
        warn("Dispenser: Templates folder not found")
        return nil
    end

    local template = templates:FindFirstChild(self.itemType)
    if not template then
        warn("Dispenser: Template not found:", self.itemType)
        return nil
    end

    self.remaining = self.remaining - 1
    return template:Clone()
end

function Dispenser:isEmpty()
    return self.remaining <= 0
end

function Dispenser:refill()
    self.remaining = self.capacity
end

return Dispenser
```

**Key Points:**
- Pure Lua class, no Roblox-specific inheritance
- Looks up templates by name in `ReplicatedStorage/Templates`
- Returns cloned item (caller decides where to parent it)
- Tracks remaining count internally

### Server Script (ServerScriptService/Script.server.lua)

```lua
-- Dispenser.Script (Server)
-- Handles ProximityPrompt interaction and item dispensing

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local Dispenser = require(ReplicatedStorage:WaitForChild("Dispenser.ModuleScript"))

local function setupDispenser(model)
    -- Get config from model attributes
    local itemType = model:GetAttribute("DispenseItem") or "Marshmallow"
    local capacity = model:GetAttribute("Capacity") or 10

    -- Create dispenser instance
    local dispenser = Dispenser.new(itemType, capacity)

    -- Find Anchor
    local anchor = model:FindFirstChild("Anchor")
    if not anchor then
        warn("Dispenser: No Anchor found in", model.Name)
        return
    end

    -- Configure mesh from MeshName attribute
    local meshName = model:GetAttribute("MeshName")
    if meshName then
        local mesh = anchor:FindFirstChild(meshName)
        if mesh then
            mesh.Size = anchor.Size
            mesh.CFrame = anchor.CFrame
            mesh.Anchored = true
            anchor.Transparency = 1
        else
            warn("Dispenser: Mesh not found:", meshName)
        end
    end

    -- Find ProximityPrompt
    local prompt = anchor:FindFirstChild("ProximityPrompt")
    if not prompt then
        warn("Dispenser: No ProximityPrompt found in", model.Name)
        return
    end

    -- Set initial remaining count
    model:SetAttribute("Remaining", dispenser.remaining)

    -- Handle interaction
    prompt.Triggered:Connect(function(player)
        local item = dispenser:dispense()
        if item then
            item.Parent = ReplicatedStorage
            model:SetAttribute("Remaining", dispenser.remaining)
            print("Dispenser: Gave", item.Name, "to", player.Name)
        else
            print("Dispenser: Empty")
        end
    end)

    print("Dispenser: Set up", model.Name, "(DispenseItem:" .. itemType .. ", Capacity:" .. capacity .. ")")
end

-- Wait for model in RuntimeAssets
local runtimeAssets = game.Workspace:WaitForChild("RuntimeAssets")
local model = runtimeAssets:WaitForChild("Dispenser")
setupDispenser(model)

print("Dispenser.Script loaded")
```

**Key Points:**
- Waits for `RuntimeAssets/Dispenser` (deployed by System)
- Reads configuration from model Attributes
- Requires the extracted ModuleScript (`Dispenser.ModuleScript`)
- Connects ProximityPrompt to dispense logic
- Updates `Remaining` attribute (auto-replicates to clients)

### Model Attributes (Set in Studio)

| Attribute | Type | Description | Example |
|-----------|------|-------------|---------|
| `DispenseItem` | string | Template name to clone | `"Marshmallow"` |
| `Capacity` | number | Max items before empty | `10` |
| `MeshName` | string | Optional mesh child name | `"BagMesh"` |
| `Remaining` | number | Current count (set by script) | `10` |

### Runtime Flow

1. **Rojo Sync**: Dispenser model (with Anchor.rbxm) syncs to `ReplicatedStorage/Assets/Dispenser`
2. **System Bootstrap**: System extracts service folders:
   - `Dispenser.ModuleScript` → `ReplicatedStorage`
   - `Dispenser.Script` → `ServerScriptService`
3. **Asset Deployment**: Cleaned Dispenser model cloned to `Workspace/RuntimeAssets/Dispenser`
4. **Script Setup**: `Dispenser.Script` finds model, reads attributes, connects ProximityPrompt
5. **Player Interaction**: Player triggers prompt → item cloned from Templates → given to player

### Studio Setup Required

For each Dispenser instance:
1. Set Attributes (DispenseItem, Capacity)
2. Optionally add mesh as child of Anchor (set MeshName attribute)
3. Ensure `ReplicatedStorage/Templates` contains the item to dispense

### Creating a New Dispenser Variant

To create a different dispenser (e.g., "CoffeeMachine"):
1. Copy Dispenser folder structure
2. Rename folder to "CoffeeMachine"
3. Export new Anchor.rbxm with appropriate mesh/appearance
4. Set different default Attributes
5. Add coffee template to Templates folder

The same scripts work - just configure via Attributes.

---

## 11. Next Steps (Not Started)

1. Test full runtime flow (System bootstrap → Dispenser deployment → ProximityPrompt interaction)
2. Build out Player module functionality
3. Create additional asset modules following Dispenser pattern
4. Consider CI/CD for automated testing
