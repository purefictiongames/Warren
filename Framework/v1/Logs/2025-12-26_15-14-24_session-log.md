# Session Log: 2025-12-26 (Session 5)

## Overview

This session focused on completing the game loop by adding the Orchestrator asset, fixing timer/reset issues, and refining the scoring system. Also attempted backpack limits (rolled back for later).

---

## 1. Orchestrator Asset

### Concept

Orchestrator coordinates game flow by listening to events and triggering actions. For now, it listens to `RoundComplete` from Scoreboard and resets TimedEvaluator.

### Filesystem Structure

```
src/Assets/Orchestrator/
├── init.meta.json              # className: "Model"
└── ServerScriptService/
    └── Script.server.lua       # Event listener + reset trigger
```

### Server Script

```lua
-- Orchestrator.Script (Server)
-- Coordinates game flow by listening to events and triggering actions

local ReplicatedStorage = game:GetService("ReplicatedStorage")

local function setupOrchestrator()
    local roundComplete = ReplicatedStorage:WaitForChild("Scoreboard.RoundComplete")

    local runtimeAssets = game.Workspace:WaitForChild("RuntimeAssets")
    local timedEvaluator = runtimeAssets:WaitForChild("TimedEvaluator")
    local resetFunction = timedEvaluator:WaitForChild("Reset")

    local function onRoundComplete(result)
        print("Orchestrator: Round complete - resetting TimedEvaluator")
        task.wait(2)  -- Let player see score
        resetFunction:Invoke()
        print("Orchestrator: TimedEvaluator reset - new round started")
    end

    roundComplete.Event:Connect(onRoundComplete)
end

setupOrchestrator()
```

### Event Flow

```
TimedEvaluator → EvaluationComplete → Scoreboard → ScoreUpdate (client)
                                                 → RoundComplete
                                                        ↓
                                               Orchestrator (2s delay)
                                                        ↓
                                               TimedEvaluator.Reset()
```

---

## 2. RoundComplete Event

Added `RoundComplete` BindableEvent to Scoreboard for Orchestrator to observe.

### Location

```
src/Assets/Scoreboard/ReplicatedStorage/RoundComplete/
└── init.meta.json              # className: "BindableEvent"
```

### Scoreboard Updates

Scoreboard now fires `RoundComplete` after scoring, even on timeout:

```lua
-- Signal round complete (for Orchestrator) - always fire to reset
roundComplete:Fire({
    player = player,
    roundScore = score,
    totalScore = player and playerScores[player] or 0,
    timeout = not result.submitted,
})
```

---

## 3. TimedEvaluator Fixes

### Timer Generation Counter

Fixed race condition where old timer threads could interfere with new ones:

```lua
local timerGeneration = 0

local function startTimer()
    timerGeneration = timerGeneration + 1
    local myGeneration = timerGeneration

    timerThread = task.spawn(function()
        -- Check generation to ensure this timer is still valid
        while timeRemaining > 0 and isRunning and myGeneration == timerGeneration do
            task.wait(1)
            timeRemaining = timeRemaining - 1
            model:SetAttribute("TimeRemaining", timeRemaining)
        end

        -- Only evaluate if still current timer
        if isRunning and not hasEvaluated and myGeneration == timerGeneration then
            evaluate(nil, nil)
        end
    end)
end
```

### Target Range Attributes

Added configurable target range via attributes:

```lua
local targetMin = model:GetAttribute("TargetMin")
local targetMax = model:GetAttribute("TargetMax")
if targetMin == nil or targetMin <= 0 then targetMin = 30 end
if targetMax == nil or targetMax <= 0 then targetMax = 100 end
if targetMin > targetMax then targetMin, targetMax = targetMax, targetMin end
```

**Model Attributes:**
| Attribute | Type | Description | Default |
|-----------|------|-------------|---------|
| `TargetMin` | number | Minimum target value | 30 |
| `TargetMax` | number | Maximum target value | 100 |

### Thread Cancellation Safety

Wrapped thread cancellation in pcall to prevent errors when thread already finished:

```lua
if timerThread then
    pcall(function() task.cancel(timerThread) end)
    timerThread = nil
end
```

---

## 4. HUD Score Rounding

Updated LocalScript to round displayed score to nearest 5:

```lua
local function roundToNearest5(value)
    return math.floor((value + 2.5) / 5) * 5
end

local function updateDisplay(data)
    if scoreLabel then
        local displayScore = roundToNearest5(math.floor(data.totalScore))
        scoreLabel.Text = "Score: " .. tostring(displayScore)
    end
end
```

---

## 5. Timeout Handling

Fixed issue where timeout (no player submission) would leave TimedEvaluator stuck.

**Problem:** When timer expired, Scoreboard returned early (no player), so `RoundComplete` never fired and Orchestrator never reset.

**Solution:** Scoreboard now always fires `RoundComplete`, even without a player:

```lua
if player then
    -- Score and update client
else
    print("Scoreboard: Timeout - no submission")
end

-- Always fire RoundComplete
roundComplete:Fire({ ... })
```

---

## 6. Backpack Limits (Attempted - Rolled Back)

Attempted to add marshmallow limit (1 per player) in Player.Script using `Backpack.ChildAdded`. The event handler wasn't firing as expected - needs investigation.

**Approach tried:**
- Listen to `Backpack.ChildAdded`
- Count items of same name
- Destroy oldest if over limit

**Issue:** ChildAdded callbacks weren't executing. May be related to how System bootstrap handles Player module timing, or Roblox's event behavior with Tools.

**Status:** Rolled back for future investigation.

---

## 7. Known Issues

### Scoring Formula Needs Tuning

**Problem:** Players can get higher scores by NOT toasting and submitting quickly.

**Root Cause:** With 60/40 accuracy/speed split:
- Raw marshmallow (ToastLevel ~0) vs target of 30 = diff of 30
- Accuracy score: `60 - (30 * 6) = 0`
- But speed bonus still applies if submitted quickly
- Fast submission with 0 accuracy beats slow submission with good accuracy

**Potential Solutions (for later):**
1. Minimum accuracy threshold to earn any points
2. Multiply: `finalScore = accuracy * speedMultiplier`
3. Increase accuracy penalty per diff point
4. Require minimum ToastLevel to submit

---

## 8. Current Game Loop (Working)

1. **Dispenser** → Player triggers → Marshmallow to Backpack
2. **ZoneController** → Player enters zone → `cook` method ticked → ToastLevel increases
3. **TimedEvaluator** → Countdown runs → Player submits or timeout
4. **Scoreboard** → Calculates score (60% accuracy + 40% speed) → Updates HUD
5. **Orchestrator** → Catches RoundComplete → Waits 2s → Resets TimedEvaluator
6. Loop repeats

---

## 9. Current File Structure

```
Framework/v1/
└── src/
    ├── Assets/
    │   ├── Dispenser/
    │   ├── ZoneController/
    │   ├── TimedEvaluator/
    │   │   ├── init.meta.json
    │   │   ├── Anchor.rbxm
    │   │   └── ServerScriptService/
    │   │       └── Script.server.lua    # Timer generation, target range
    │   ├── Scoreboard/
    │   │   ├── init.meta.json
    │   │   ├── ReplicatedStorage/
    │   │   │   ├── ScoreUpdate.rbxm
    │   │   │   └── RoundComplete/       # NEW
    │   │   │       └── init.meta.json
    │   │   ├── ServerScriptService/
    │   │   │   └── Script.server.lua    # Timeout handling
    │   │   └── StarterGui/
    │   │       ├── LocalScript.client.lua  # Score rounding
    │   │       └── ScreenGui.rbxm
    │   └── Orchestrator/                # NEW
    │       ├── init.meta.json
    │       └── ServerScriptService/
    │           └── Script.server.lua
    ├── Templates/
    │   └── Marshmallow/
    └── System/
        ├── Script.server.lua            # StarterGui support
        └── Player/
```

---

## 10. Next Steps

1. **Tune scoring formula** - Fix raw marshmallow exploit
2. **Backpack limits** - Investigate ChildAdded issue
3. **Display target value** - Show player what ToastLevel to aim for
4. **Display time remaining** - HUD countdown
5. **Visual feedback** - Marshmallow color change, particles
6. **RoastStick tool** - Hold marshmallow on a stick
7. **Campfire visuals** - Replace ZoneController placeholder
