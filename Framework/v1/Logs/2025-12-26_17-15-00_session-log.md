# Session Log: 2025-12-26 (Session 7)

## Overview

This session added the LeaderBoard asset - a persistent top 10 high score board displayed on an in-world SurfaceGui. Scores are tracked per timed round and saved to DataStore.

---

## 1. LeaderBoard Asset

### Concept

LeaderBoard displays the top 10 highest scores across all players and sessions:
- Arcade-style ranking (same player can hold multiple spots)
- Scores posted only when timed round ends (GlobalTimer expired or Dispenser empty)
- Persistent via DataStore
- Displayed on a SurfaceGui attached to an in-world Billboard part

### Filesystem Structure

```
src/Assets/LeaderBoard/
├── init.meta.json              # className: "Model"
├── Billboard.rbxm              # Part with SurfaceGui (created in Studio)
└── ServerScriptService/
    └── Script.server.lua       # Score tracking + display
```

### Model Attributes

None required - all config is in script constants.

### Server Script Features

**DataStore Persistence**
```lua
local DATASTORE_NAME = "LeaderBoard_v1"
local DATASTORE_KEY = "TopScores"
```

**Score Tracking Flow**
1. Per-marshmallow: `RoundComplete` fires → track cumulative score per player (don't post yet)
2. Round ends: `GlobalTimer.TimerExpired` OR `Dispenser.Empty` fires → post final scores to leaderboard
3. Only scores that qualify for top 10 are added
4. Lowest score gets bumped when table is full

**Display Format**
```
 1. PlayerName       100
 2. OtherPlayer       85
 3. ---              ---
```
- Fixed-width spacing (no tabs)
- Names truncated to 16 chars
- Scores rounded to whole numbers

### Server Script (Script.server.lua)

```lua
-- LeaderBoard.Script (Server)
-- Tracks top 10 scores with DataStore persistence

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local DataStoreService = game:GetService("DataStoreService")

local DATASTORE_NAME = "LeaderBoard_v1"
local DATASTORE_KEY = "TopScores"

local function setupLeaderBoard(model)
    local billboard = model:FindFirstChild("Billboard")
    local surfaceGui = billboard:FindFirstChild("SurfaceGui")
    local textLabel = surfaceGui:FindFirstChild("TextLabel", true)

    -- Size TextLabel to fill the SurfaceGui
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.Position = UDim2.new(0, 0, 0, 0)
    textLabel.TextXAlignment = Enum.TextXAlignment.Left
    textLabel.TextYAlignment = Enum.TextYAlignment.Top
    textLabel.TextScaled = true
    textLabel.BackgroundTransparency = 1

    -- Score tracking: array of { name, score } entries (top 10)
    local scores = {}
    local maxEntries = 10
    local currentRoundScores = {}

    -- DataStore setup (graceful fallback if unavailable)
    local dataStore = nil
    pcall(function()
        dataStore = DataStoreService:GetDataStore(DATASTORE_NAME)
    end)

    -- Add score to leaderboard (maintains sorted top 10)
    local function addScore(playerName, score)
        score = math.floor(score + 0.5)  -- Round to whole number
        table.insert(scores, { name = playerName, score = score })
        table.sort(scores, function(a, b) return a.score > b.score end)
        while #scores > maxEntries do
            table.remove(scores)
        end
        updateDisplay()
        saveScores()
    end

    -- Track per-marshmallow (don't post yet)
    local roundComplete = ReplicatedStorage:WaitForChild("Scoreboard.RoundComplete")
    roundComplete.Event:Connect(function(result)
        if result.player then
            currentRoundScores[result.player.Name] = result.totalScore or 0
        end
    end)

    -- Post scores when round ends
    local function onRoundEnd()
        for playerName, totalScore in pairs(currentRoundScores) do
            if totalScore > 0 then
                if #scores < maxEntries or totalScore > scores[#scores].score then
                    addScore(playerName, totalScore)
                end
            end
        end
        currentRoundScores = {}
    end

    -- Listen for round end triggers
    ReplicatedStorage:WaitForChild("GlobalTimer.TimerExpired").Event:Connect(onRoundEnd)
    ReplicatedStorage:WaitForChild("Dispenser.Empty").Event:Connect(onRoundEnd)
end
```

### Billboard.rbxm Contents (Created in Studio)

```
Billboard (Part)
└── SurfaceGui
    └── TextLabel
```

**SurfaceGui Tips:**
- Set `SizingMode` to `PixelsPerStud` for consistent sizing
- Set `Face` to the correct side of the part
- Use monospace font (Code, RobotoMono) for best alignment

---

## 2. GlobalTimer Update

Changed default countdown from 3 minutes to 1 minute for faster testing:

```lua
local countdownStart = model:GetAttribute("CountdownStart") or 1.00
```

---

## 3. Admin: Clearing the LeaderBoard

No in-game reset function (leaderboard is persistent). To clear manually via Studio command bar:

```lua
local DataStoreService = game:GetService("DataStoreService")
local ds = DataStoreService:GetDataStore("LeaderBoard_v1")
ds:RemoveAsync("TopScores")
```

Requires **Game Settings → Security → Enable Studio Access to API Services**.

---

## 4. Design Decisions

### Arcade-Style Top 10
- Same player can hold multiple rank spots
- Each timed round creates a new score entry
- Only top 10 are kept (lowest bumped when full)

### Round-End Posting Only
- Scores tracked during round but not posted per-marshmallow
- Final score posted when GlobalTimer expires OR Dispenser empties
- Prevents leaderboard spam during gameplay

### Persistent Across Sessions
- DataStore saves after each update
- Loads on server start
- Graceful fallback if DataStore unavailable

---

## 5. Event Flow

```
Per-Marshmallow:
TimedEvaluator → EvaluationComplete → Scoreboard → RoundComplete → LeaderBoard (tracks)

Round End:
GlobalTimer.TimerExpired  ─┬→ LeaderBoard (posts scores)
Dispenser.Empty          ─┘
                           └→ Orchestrator (resets all)
```

---

## 6. Files Changed

### New Files

```
src/Assets/LeaderBoard/
├── init.meta.json
├── Billboard.rbxm
└── ServerScriptService/
    └── Script.server.lua
```

### Modified Files

- `src/Assets/GlobalTimer/ServerScriptService/Script.server.lua` - Default countdown 1 minute

---

## 7. Current Asset List

| Asset | Purpose |
|-------|---------|
| Dispenser | Gives marshmallows, fires Empty event |
| ZoneController | Cooks marshmallows in zone |
| TimedEvaluator | Scores accuracy vs target |
| Scoreboard | Calculates points, HUD display |
| GlobalTimer | Round countdown, HUD display |
| Orchestrator | Event coordinator, resets assets |
| LeaderBoard | Persistent top 10 high scores |

---

## 8. Next Steps

1. Style the LeaderBoard SurfaceGui (fonts, colors)
2. Display target ToastLevel on HUD
3. Visual feedback for marshmallow cooking (color change)
4. End-of-round summary screen
5. Multiple dispensers / zones for larger maps
